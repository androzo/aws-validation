name: Validate IAM Role Policies
description: Validates IAM Terraform roles using OPA and Rego policies.

inputs:
  tfplan_path:
    description: Path to the Terraform plan in JSON format.
    required: true

runs:
  using: "composite"
  steps:
    - name: Install conftest
      shell: bash
      run: |
        wget https://github.com/open-policy-agent/conftest/releases/download/v0.58.0/conftest_0.58.0_Linux_x86_64.tar.gz > /dev/null 2>&1
        tar -xzf conftest_0.58.0_Linux_x86_64.tar.gz
        chmod +x conftest && sudo mv conftest /usr/local/bin/

    - name: Validate IAM Policies with Conftest
      shell: bash
      run: |
        cat ${{ inputs.tfplan_path }}
        conftest test ${{ inputs.tfplan_path }} --policy ${{ github.action_path }}/policy/iam/
